import{_ as Ae,r as l,j as ve,l as $e,h as Ne,c as n,a,d as v,t as i,u as S,n as O,F as pe,f as me,e as Se,k as Z,g as Oe,i as f,o as u}from"./index-CBvISKLU.js";const Ve={class:"dashboard-layout"},qe={class:"navbar"},We={class:"user-info"},Be={key:0},Ge={class:"main-container"},Ie={class:"sidebar"},Je={class:"content"},ze={class:"card mb-30"},Ee={class:"upload-grid"},He={class:"upload-panel"},Ke=["disabled"],Qe={class:"upload-panel"},Xe={key:0,class:"msg bad",style:{margin:"10px 0 0"}},Ye=["disabled"],Ze={class:"upload-panel"},ea={key:0,class:"msg bad",style:{margin:"10px 0 0"}},aa=["disabled"],sa={class:"upload-panel"},ta={key:0,class:"msg bad",style:{margin:"10px 0 0"}},la=["disabled"],oa={class:"card"},na={key:0,class:"loading-text"},ua={key:1,class:"empty-state"},da={key:2,class:"doc-list"},ia={class:"info"},ca={class:"title"},ra={class:"meta"},va={key:0},pa={key:0,class:"comment"},ma={class:"actions"},fa=["onClick"],_a=["onClick"],ha=["onClick","disabled"],ga=["onClick","disabled"],ya={key:0,class:"modal-overlay"},ba={class:"modal-box wide-modal"},ka={key:0,class:"comment-meta"},Ca={class:"comment-list"},wa={key:0,class:"loading-text"},Da={key:1,class:"empty-state"},Fa={key:2},Ua={class:"comment-head"},Ra={class:"comment-author"},ja={class:"comment-time"},Ma={class:"comment-body"},Ta={class:"modal-actions"},xa=["disabled"],Pa={key:1,class:"modal-overlay"},La={class:"modal-box wide-modal"},Aa={key:0,class:"comment-meta"},$a=["accept"],Na={class:"modal-actions"},Sa=["disabled"],Oa={key:2,class:"modal-overlay"},Va={class:"modal-box wide-modal"},qa={key:0,class:"comment-meta"},Wa={class:"modal-actions"},Ba=["disabled"],Ga=["disabled"],Ia={__name:"DocumentsView",setup(Ja){const w=Ne(),J=l({}),z=l(!0),E=l([]),x=l(null),P=l(null),L=l(null),A=l(null),V=l(!1),q=l(!1),W=l(!1),B=l(!1),c=l(""),p=l(!0),H=l(!1),_=l(null),$=l([]),K=l(!1),D=l(""),G=l(!1),k=l(""),j=l(!0),h=l({term_number:1,unlocks:{term2:!1,term3:!1}}),ee=ve(()=>{var e;const s=Number(((e=h.value)==null?void 0:e.term_number)||1);return s>=3&&s<=4}),fe=s=>{var e,t;x.value=((t=(e=s==null?void 0:s.target)==null?void 0:e.files)==null?void 0:t[0])??null},_e=s=>{var e,t;P.value=((t=(e=s==null?void 0:s.target)==null?void 0:e.files)==null?void 0:t[0])??null},he=s=>{var e,t;L.value=((t=(e=s==null?void 0:s.target)==null?void 0:e.files)==null?void 0:t[0])??null},ge=s=>{var e,t;A.value=((t=(e=s==null?void 0:s.target)==null?void 0:e.files)==null?void 0:t[0])??null},F=async()=>{z.value=!0;try{const s=await f.get("get_status.php");s.data.status==="success"&&(E.value=s.data.documents||[],h.value=s.data.term||h.value)}finally{z.value=!1}},ye=async()=>{var s,e;if(L.value){W.value=!0,c.value="";try{const t=new FormData;t.append("file",L.value);const o=await f.post("upload_thesis_project.php",t);o.data.status==="success"?(p.value=!0,c.value="Thesis/Project file uploaded. Waiting for review.",L.value=null,await F()):(p.value=!1,c.value=o.data.message||"Upload failed")}catch(t){p.value=!1,c.value=((e=(s=t==null?void 0:t.response)==null?void 0:s.data)==null?void 0:e.message)||"Upload failed"}finally{W.value=!1}}},be=async()=>{var s,e;if(x.value){V.value=!0,c.value="";try{const t=new FormData;t.append("file",x.value);const o=await f.post("upload_letter.php",t);o.data.status==="success"?(p.value=!0,c.value="Admission letter uploaded. Waiting for review.",x.value=null,await F()):(p.value=!1,c.value=o.data.message||"Upload failed")}catch(t){p.value=!1,c.value=((e=(s=t==null?void 0:t.response)==null?void 0:s.data)==null?void 0:e.message)||"Upload failed"}finally{V.value=!1}}},ke=async()=>{var s,e;if(P.value){q.value=!0,c.value="";try{const t=new FormData;t.append("file",P.value);const o=await f.post("upload_major_professor_form.php",t);o.data.status==="success"?(p.value=!0,c.value="Major Professor form uploaded. Waiting for review.",P.value=null,await F()):(p.value=!1,c.value=o.data.message||"Upload failed")}catch(t){p.value=!1,c.value=((e=(s=t==null?void 0:t.response)==null?void 0:s.data)==null?void 0:e.message)||"Upload failed"}finally{q.value=!1}}},Ce=async()=>{var s,e;if(A.value){B.value=!0,c.value="";try{const t=new FormData;t.append("file",A.value);const o=await f.post("upload_research_method_proof.php",t);o.data.status==="success"?(p.value=!0,c.value=o.data.message||"Research Method proof uploaded.",A.value=null,await F()):(p.value=!1,c.value=o.data.message||"Upload failed")}catch(t){p.value=!1,c.value=((e=(s=t==null?void 0:t.response)==null?void 0:s.data)==null?void 0:e.message)||"Upload failed"}finally{B.value=!1}}},we=async s=>{var e,t;try{const m=(await f.get(`download_document.php?doc_id=${s.doc_id}`,{responseType:"blob"})).data,r=URL.createObjectURL(m);window.open(r,"_blank","noopener,noreferrer"),setTimeout(()=>URL.revokeObjectURL(r),6e4)}catch(o){p.value=!1,c.value=((t=(e=o==null?void 0:o.response)==null?void 0:e.data)==null?void 0:t.message)||"Failed to open document."}},De=async s=>{_.value=s,H.value=!0,D.value="",k.value="",$.value=[],K.value=!0;try{await ae(s.doc_id)}finally{K.value=!1}},Fe=()=>{H.value=!1,_.value=null,$.value=[],D.value="",k.value=""},Ue=async()=>{var s,e,t,o;if(_.value){G.value=!0,k.value="",j.value=!0;try{const m=await f.post("document_comments_add.php",{doc_id:_.value.doc_id,comment:D.value});((s=m.data)==null?void 0:s.status)==="success"?(j.value=!0,k.value="Posted.",D.value="",await ae(_.value.doc_id)):(j.value=!1,k.value=((e=m.data)==null?void 0:e.message)||"Failed to post")}catch(m){j.value=!1,k.value=((o=(t=m==null?void 0:m.response)==null?void 0:t.data)==null?void 0:o.message)||"Failed to post"}finally{G.value=!1}}},ae=async s=>{var t;const e=await f.get(`document_comments_list.php?doc_id=${s}`);((t=e.data)==null?void 0:t.status)==="success"&&($.value=e.data.data||[])},se=s=>String((s==null?void 0:s.status)||"").toLowerCase()!=="approved",Q=l(!1),g=l(null),M=l(null),I=l(!1),y=l(""),U=l(!0),X=l(!1),C=l(null),N=l(!1),b=l(""),R=l(!0),Re=ve(()=>{var e;return String(((e=g.value)==null?void 0:e.doc_type)||"")==="thesis_project"?".pdf":".pdf,.jpg,.jpeg,.png"}),je=s=>{g.value=s,M.value=null,y.value="",U.value=!0,Q.value=!0},te=()=>{Q.value=!1,g.value=null,M.value=null,y.value=""},Me=s=>{var e,t;M.value=((t=(e=s==null?void 0:s.target)==null?void 0:e.files)==null?void 0:t[0])??null},Te=async()=>{var s,e,t,o,m;if(!(!g.value||!M.value)){I.value=!0,y.value="",U.value=!0;try{const r=new FormData;r.append("doc_id",String(g.value.doc_id)),r.append("file",M.value);const T=await f.post("student_replace_document.php",r);((s=T.data)==null?void 0:s.status)==="success"?(U.value=!0,y.value=((e=T.data)==null?void 0:e.message)||"Replaced.",p.value=!0,c.value=y.value,await F(),te()):(U.value=!1,y.value=((t=T.data)==null?void 0:t.message)||"Replace failed")}catch(r){U.value=!1,y.value=((m=(o=r==null?void 0:r.response)==null?void 0:o.data)==null?void 0:m.message)||"Replace failed"}finally{I.value=!1}}},xe=s=>{C.value=s,b.value="",R.value=!0,X.value=!0},le=()=>{X.value=!1,C.value=null,b.value=""},Pe=async()=>{var s,e,t,o,m;if(C.value){N.value=!0,b.value="",R.value=!0;try{const r=await f.post("student_delete_document.php",{doc_id:C.value.doc_id});((s=r.data)==null?void 0:s.status)==="success"?(R.value=!0,b.value=((e=r.data)==null?void 0:e.message)||"Deleted.",p.value=!0,c.value=b.value,await F(),le()):(R.value=!1,b.value=((t=r.data)==null?void 0:t.message)||"Delete failed")}catch(r){R.value=!1,b.value=((m=(o=r==null?void 0:r.response)==null?void 0:o.data)==null?void 0:m.message)||"Delete failed"}finally{N.value=!1}}},Le=async()=>{try{await f.post("logout.php")}catch{}localStorage.removeItem("user"),w.push("/")};return $e(()=>{const s=localStorage.getItem("user");if(!s)return w.push("/");J.value=JSON.parse(s),F()}),(s,e)=>{var t,o,m,r,T,oe,ne,ue,de,ie,ce,re;return u(),n("div",Ve,[a("header",qe,[e[6]||(e[6]=a("div",{class:"brand"},"Grad System",-1)),a("div",We,[J.value.username?(u(),n("span",Be,"Welcome, "+i(J.value.username),1)):v("",!0),a("button",{onClick:Le,class:"btn-logout"},"Logout")])]),a("div",Ge,[a("aside",Ie,[a("nav",null,[a("ul",null,[a("li",{onClick:e[0]||(e[0]=d=>S(w).push("/dashboard"))},"Dashboard"),a("li",{onClick:e[1]||(e[1]=d=>S(w).push("/my-courses"))},"My Courses"),e[7]||(e[7]=a("li",{class:"active"},"Documents",-1)),a("li",{onClick:e[2]||(e[2]=d=>S(w).push("/assignments"))},"Assignments"),(o=(t=h.value)==null?void 0:t.unlocks)!=null&&o.term2?(u(),n("li",{key:0,onClick:e[3]||(e[3]=d=>S(w).push("/major-professor"))},"Major Professor")):v("",!0),(r=(m=h.value)==null?void 0:m.unlocks)!=null&&r.term3?(u(),n("li",{key:1,onClick:e[4]||(e[4]=d=>S(w).push("/thesis-project"))},"Thesis / Project")):v("",!0)])])]),a("main",Je,[a("div",ze,[e[16]||(e[16]=a("h2",null,"Upload Documents",-1)),a("div",Ee,[a("div",He,[e[8]||(e[8]=a("h3",null,"Admission Letter",-1)),e[9]||(e[9]=a("p",{class:"text-muted"},"Required for Term 1 hold release.",-1)),a("input",{type:"file",onChange:fe,accept:".pdf,.jpg,.png"},null,32),a("button",{class:"btn-primary",onClick:be,disabled:!x.value||V.value},i(V.value?"Uploading...":"Upload"),9,Ke)]),a("div",Qe,[e[10]||(e[10]=a("h3",null,"Major Professor Form",-1)),e[11]||(e[11]=a("p",{class:"text-muted"},"Required for Term 2 hold release.",-1)),(oe=(T=h.value)==null?void 0:T.unlocks)!=null&&oe.term2?v("",!0):(u(),n("div",Xe," Locked: available starting Term 2. ")),a("input",{type:"file",onChange:_e,accept:".pdf,.jpg,.png"},null,32),a("button",{class:"btn-primary",onClick:ke,disabled:!((ue=(ne=h.value)==null?void 0:ne.unlocks)!=null&&ue.term2)||!P.value||q.value},i(q.value?"Uploading...":"Upload"),9,Ye)]),a("div",Ze,[e[12]||(e[12]=a("h3",null,"Thesis / Project",-1)),e[13]||(e[13]=a("p",{class:"text-muted"},"Upload your thesis/project file (PDF). Allowed only in Term 3 and Term 4.",-1)),ee.value?v("",!0):(u(),n("div",ea," Locked: available only in Term 3 and Term 4. ")),a("input",{type:"file",onChange:he,accept:".pdf"},null,32),a("button",{class:"btn-primary",onClick:ye,disabled:!ee.value||!L.value||W.value},i(W.value?"Uploading...":"Upload"),9,aa)]),a("div",sa,[e[14]||(e[14]=a("h3",null,"Research Method (Proof)",-1)),e[15]||(e[15]=a("p",{class:"text-muted"}," Term 3 hold release requires you to register/take the Research Method course. Faculty will verify your course registration. Upload proof here if requested (PDF/JPG/PNG). ",-1)),(ie=(de=h.value)==null?void 0:de.unlocks)!=null&&ie.term3?v("",!0):(u(),n("div",ta," Locked: available starting Term 3. ")),a("input",{type:"file",onChange:ge,accept:".pdf,.jpg,.jpeg,.png"},null,32),a("button",{class:"btn-primary",onClick:Ce,disabled:!((re=(ce=h.value)==null?void 0:ce.unlocks)!=null&&re.term3)||!A.value||B.value},i(B.value?"Uploading...":"Upload"),9,la)])]),c.value?(u(),n("div",{key:0,class:O(["msg",{ok:p.value,bad:!p.value}])},i(c.value),3)):v("",!0)]),a("div",oa,[e[17]||(e[17]=a("h2",null,"My Documents",-1)),z.value?(u(),n("div",na,"Loading...")):E.value.length===0?(u(),n("div",ua,"No documents uploaded.")):(u(),n("div",da,[(u(!0),n(pe,null,me(E.value,d=>(u(),n("div",{key:d.doc_id,class:"doc-item"},[a("div",ia,[a("div",ca,[a("strong",null,i(d.doc_type),1),a("span",{class:O(["badge",d.status])},i(d.status),3)]),a("div",ra,[a("span",null,i(d.file_path),1),d.upload_date?(u(),n("span",va,"路 "+i(d.upload_date),1)):v("",!0)]),d.admin_comment?(u(),n("div",pa,"Admin comment: "+i(d.admin_comment),1)):v("",!0)]),a("div",ma,[a("button",{class:"btn-secondary",onClick:Y=>we(d)},"View",8,fa),a("button",{class:"btn-secondary",onClick:Y=>De(d)},"Comments",8,_a),a("button",{class:"btn-secondary",onClick:Y=>je(d),disabled:!se(d)},"Replace",8,ha),a("button",{class:"btn-danger",onClick:Y=>xe(d),disabled:!se(d)},"Delete",8,ga)])]))),128))]))])])]),H.value?(u(),n("div",ya,[a("div",ba,[e[18]||(e[18]=a("h3",null,"Comments",-1)),_.value?(u(),n("div",ka,[a("strong",null,i(_.value.doc_type),1),Z(" 路 doc_id="+i(_.value.doc_id),1)])):v("",!0),a("div",Ca,[K.value?(u(),n("div",wa,"Loading comments...")):$.value.length===0?(u(),n("div",Da,"No comments yet.")):(u(),n("div",Fa,[(u(!0),n(pe,null,me($.value,d=>(u(),n("div",{key:d.id,class:"comment-item"},[a("div",Ua,[a("span",Ra,i(d.author_username||d.author_role),1),a("span",ja,i(d.created_at),1)]),a("div",Ma,i(d.comment),1)]))),128))]))]),Se(a("textarea",{"onUpdate:modelValue":e[5]||(e[5]=d=>D.value=d),placeholder:"Add a note...",rows:"3"},null,512),[[Oe,D.value]]),k.value?(u(),n("div",{key:1,class:O(["msg",{ok:j.value,bad:!j.value}])},i(k.value),3)):v("",!0),a("div",Ta,[a("button",{class:"btn-cancel",onClick:Fe},"Close"),a("button",{class:"btn-primary",onClick:Ue,disabled:G.value||!D.value.trim()||!_.value},i(G.value?"Posting...":"Post"),9,xa)])])])):v("",!0),Q.value?(u(),n("div",Pa,[a("div",La,[e[19]||(e[19]=a("h3",null,"Replace Document",-1)),g.value?(u(),n("div",Aa,[a("strong",null,i(g.value.doc_type),1),Z(" 路 doc_id="+i(g.value.doc_id),1)])):v("",!0),a("input",{type:"file",onChange:Me,accept:Re.value},null,40,$a),y.value?(u(),n("div",{key:1,class:O(["msg",{ok:U.value,bad:!U.value}])},i(y.value),3)):v("",!0),a("div",Na,[a("button",{class:"btn-cancel",onClick:te},"Cancel"),a("button",{class:"btn-primary",onClick:Te,disabled:I.value||!M.value||!g.value},i(I.value?"Uploading...":"Replace"),9,Sa)])])])):v("",!0),X.value?(u(),n("div",Oa,[a("div",Va,[e[20]||(e[20]=a("h3",null,"Delete Document",-1)),C.value?(u(),n("div",qa,[a("strong",null,i(C.value.doc_type),1),Z(" 路 "+i(C.value.file_path),1)])):v("",!0),e[21]||(e[21]=a("div",{class:"msg bad"},"This will remove the file from the system. Approved documents cannot be deleted.",-1)),b.value?(u(),n("div",{key:1,class:O(["msg",{ok:R.value,bad:!R.value}])},i(b.value),3)):v("",!0),a("div",Wa,[a("button",{class:"btn-cancel",onClick:le,disabled:N.value},"Cancel",8,Ba),a("button",{class:"btn-danger",onClick:Pe,disabled:N.value||!C.value},i(N.value?"Deleting...":"Delete"),9,Ga)])])])):v("",!0)])}}},Ea=Ae(Ia,[["__scopeId","data-v-c20c271f"]]);export{Ea as default};

import{_ as Ne,r as t,l as te,o as Se,i as Ve,c as u,a,d as v,t as i,u as _,g as O,n as q,F as fe,f as _e,e as Oe,m as oe,h as qe,j as f,k as d}from"./index-CqwOMfHx.js";import{d as We,f as Be,s as Ge,a as Ie}from"./docDisplay-CK9INdz_.js";import{F as W}from"./FilePicker-DKtqNUbc.js";const ze={class:"dashboard-layout"},Je={class:"navbar"},Ee={class:"user-info"},He={key:0},Ke={class:"main-container"},Qe={class:"sidebar"},Xe={class:"content"},Ye={class:"card mb-30"},Ze={class:"upload-grid"},ea={class:"upload-panel"},aa=["disabled"],sa={class:"upload-panel"},la={key:0,class:"msg bad",style:{margin:"10px 0 0"}},ta=["disabled"],oa={class:"upload-panel"},na={key:0,class:"msg bad",style:{margin:"10px 0 0"}},ua=["disabled"],da={class:"upload-panel"},ia={key:0,class:"msg bad",style:{margin:"10px 0 0"}},ca=["disabled"],ra={class:"card"},va={key:0,class:"loading-text"},ma={key:1,class:"empty-state"},pa={key:2,class:"doc-list"},fa={class:"info"},_a={class:"doc-meta-row"},ha={class:"doc-source-pill"},ga={class:"doc-format-pill"},ya={key:0,class:"meta"},ba={key:0,class:"comment"},ka={class:"actions"},Ca=["onClick"],wa=["onClick"],Fa=["onClick","disabled"],Da=["onClick","disabled"],Ua={key:0,class:"modal-overlay"},Ra={class:"modal-box wide-modal"},Ma={key:0,class:"comment-meta"},ja={class:"comment-list"},Ta={key:0,class:"loading-text"},Pa={key:1,class:"empty-state"},xa={key:2},La={class:"comment-head"},$a={class:"comment-author"},Aa={class:"comment-time"},Na={class:"comment-body"},Sa={class:"modal-actions"},Va=["disabled"],Oa={key:1,class:"modal-overlay"},qa={class:"modal-box wide-modal"},Wa={key:0,class:"comment-meta"},Ba={class:"modal-actions"},Ga=["disabled"],Ia={key:2,class:"modal-overlay"},za={class:"modal-box wide-modal"},Ja={key:0,class:"comment-meta"},Ea={class:"modal-actions"},Ha=["disabled"],Ka=["disabled"],Qa={__name:"DocumentsView",setup(Xa){const C=Ve(),Q=t({}),X=t(!0),Y=t([]),$=t(null),A=t(null),j=t(null),T=t(null),B=t(!1),G=t(!1),I=t(!1),z=t(!1),c=t(""),m=t(!0),Z=t(!1),h=t(null),N=t([]),ee=t(!1),D=t(""),J=t(!1),w=t(""),P=t(!0),g=t({term_number:1,unlocks:{term2:!1,term3:!1}}),E=te(()=>{var e;const s=Number(((e=g.value)==null?void 0:e.term_number)||1);return s>=3&&s<=4}),H=te(()=>{var e;return Number(((e=g.value)==null?void 0:e.term_number)||1)>=3}),S=s=>{var e,l;return s?typeof File<"u"&&s instanceof File?s:((l=(e=s==null?void 0:s.target)==null?void 0:e.files)==null?void 0:l[0])??null:null},he=s=>{$.value=S(s)},ge=s=>{A.value=S(s)},ye=s=>{if(!E.value){j.value=null;return}j.value=S(s)},be=s=>{if(!H.value){T.value=null;return}T.value=S(s)},U=async()=>{X.value=!0;try{const s=await f.get("get_status.php");s.data.status==="success"&&(Y.value=s.data.documents||[],g.value=s.data.term||g.value)}finally{X.value=!1}},ke=async()=>{var s,e;if(j.value){I.value=!0,c.value="";try{const l=new FormData;l.append("file",j.value);const o=await f.post("upload_thesis_project.php",l);o.data.status==="success"?(m.value=!0,c.value="Thesis/Project file uploaded. Waiting for review.",j.value=null,await U()):(m.value=!1,c.value=o.data.message||"Upload failed")}catch(l){m.value=!1,c.value=((e=(s=l==null?void 0:l.response)==null?void 0:s.data)==null?void 0:e.message)||"Upload failed"}finally{I.value=!1}}},Ce=async()=>{var s,e;if($.value){B.value=!0,c.value="";try{const l=new FormData;l.append("file",$.value);const o=await f.post("upload_letter.php",l);o.data.status==="success"?(m.value=!0,c.value="Admission letter uploaded. Waiting for review.",$.value=null,await U()):(m.value=!1,c.value=o.data.message||"Upload failed")}catch(l){m.value=!1,c.value=((e=(s=l==null?void 0:l.response)==null?void 0:s.data)==null?void 0:e.message)||"Upload failed"}finally{B.value=!1}}},we=async()=>{var s,e;if(A.value){G.value=!0,c.value="";try{const l=new FormData;l.append("file",A.value);const o=await f.post("upload_major_professor_form.php",l);o.data.status==="success"?(m.value=!0,c.value="Major Professor form uploaded. Waiting for review.",A.value=null,await U()):(m.value=!1,c.value=o.data.message||"Upload failed")}catch(l){m.value=!1,c.value=((e=(s=l==null?void 0:l.response)==null?void 0:s.data)==null?void 0:e.message)||"Upload failed"}finally{G.value=!1}}},Fe=async()=>{var s,e;if(T.value){z.value=!0,c.value="";try{const l=new FormData;l.append("file",T.value);const o=await f.post("upload_research_method_proof.php",l);o.data.status==="success"?(m.value=!0,c.value=o.data.message||"Research Method proof uploaded.",T.value=null,await U()):(m.value=!1,c.value=o.data.message||"Upload failed")}catch(l){m.value=!1,c.value=((e=(s=l==null?void 0:l.response)==null?void 0:s.data)==null?void 0:e.message)||"Upload failed"}finally{z.value=!1}}},De=async s=>{var e,l;try{const p=(await f.get(`download_document.php?doc_id=${s.doc_id}`,{responseType:"blob"})).data,r=URL.createObjectURL(p);window.open(r,"_blank","noopener,noreferrer"),setTimeout(()=>URL.revokeObjectURL(r),6e4)}catch(o){m.value=!1,c.value=((l=(e=o==null?void 0:o.response)==null?void 0:e.data)==null?void 0:l.message)||"Failed to open document."}},Ue=async s=>{h.value=s,Z.value=!0,D.value="",w.value="",N.value=[],ee.value=!0;try{await ne(s.doc_id)}finally{ee.value=!1}},Re=()=>{Z.value=!1,h.value=null,N.value=[],D.value="",w.value=""},Me=async()=>{var s,e,l,o;if(h.value){J.value=!0,w.value="",P.value=!0;try{const p=await f.post("document_comments_add.php",{doc_id:h.value.doc_id,comment:D.value});((s=p.data)==null?void 0:s.status)==="success"?(P.value=!0,w.value="Posted.",D.value="",await ne(h.value.doc_id)):(P.value=!1,w.value=((e=p.data)==null?void 0:e.message)||"Failed to post")}catch(p){P.value=!1,w.value=((o=(l=p==null?void 0:p.response)==null?void 0:l.data)==null?void 0:o.message)||"Failed to post"}finally{J.value=!1}}},ne=async s=>{var l;const e=await f.get(`document_comments_list.php?doc_id=${s}`);((l=e.data)==null?void 0:l.status)==="success"&&(N.value=e.data.data||[])},ue=s=>String((s==null?void 0:s.status)||"").toLowerCase()!=="approved",ae=t(!1),y=t(null),x=t(null),K=t(!1),b=t(""),R=t(!0),se=t(!1),F=t(null),V=t(!1),k=t(""),M=t(!0),je=te(()=>{var e;return String(((e=y.value)==null?void 0:e.doc_type)||"")==="thesis_project"?".pdf":".pdf,.jpg,.jpeg,.png"}),Te=s=>{y.value=s,x.value=null,b.value="",R.value=!0,ae.value=!0},de=()=>{ae.value=!1,y.value=null,x.value=null,b.value=""},Pe=s=>{x.value=S(s)},xe=async()=>{var s,e,l,o,p;if(!(!y.value||!x.value)){K.value=!0,b.value="",R.value=!0;try{const r=new FormData;r.append("doc_id",String(y.value.doc_id)),r.append("file",x.value);const L=await f.post("student_replace_document.php",r);((s=L.data)==null?void 0:s.status)==="success"?(R.value=!0,b.value=((e=L.data)==null?void 0:e.message)||"Replaced.",m.value=!0,c.value=b.value,await U(),de()):(R.value=!1,b.value=((l=L.data)==null?void 0:l.message)||"Replace failed")}catch(r){R.value=!1,b.value=((p=(o=r==null?void 0:r.response)==null?void 0:o.data)==null?void 0:p.message)||"Replace failed"}finally{K.value=!1}}},Le=s=>{F.value=s,k.value="",M.value=!0,se.value=!0},ie=()=>{se.value=!1,F.value=null,k.value=""},$e=async()=>{var s,e,l,o,p;if(F.value){V.value=!0,k.value="",M.value=!0;try{const r=await f.post("student_delete_document.php",{doc_id:F.value.doc_id});((s=r.data)==null?void 0:s.status)==="success"?(M.value=!0,k.value=((e=r.data)==null?void 0:e.message)||"Deleted.",m.value=!0,c.value=k.value,await U(),ie()):(M.value=!1,k.value=((l=r.data)==null?void 0:l.message)||"Delete failed")}catch(r){M.value=!1,k.value=((p=(o=r==null?void 0:r.response)==null?void 0:o.data)==null?void 0:p.message)||"Delete failed"}finally{V.value=!1}}},Ae=async()=>{try{await f.post("logout.php")}catch{}localStorage.removeItem("user"),C.push("/")};return Se(()=>{const s=localStorage.getItem("user");if(!s)return C.push("/");Q.value=JSON.parse(s),U()}),(s,e)=>{var l,o,p,r,L,ce,re,ve,me,pe;return d(),u("div",ze,[a("header",Je,[e[7]||(e[7]=a("div",{class:"brand"},"Grad System",-1)),a("div",Ee,[Q.value.username?(d(),u("span",He,"Welcome, "+i(Q.value.username),1)):v("",!0),a("button",{onClick:Ae,class:"btn-logout"},"Logout")])]),a("div",Ke,[a("aside",Qe,[a("nav",null,[a("ul",null,[a("li",{onClick:e[0]||(e[0]=n=>_(C).push("/dashboard"))},"Dashboard"),a("li",{onClick:e[1]||(e[1]=n=>_(C).push("/my-courses"))},"My Courses"),e[8]||(e[8]=a("li",{class:"active"},"Documents",-1)),a("li",{onClick:e[2]||(e[2]=n=>_(C).push("/assignments"))},"Assignments"),a("li",{onClick:e[3]||(e[3]=n=>_(C).push("/profile"))},"Profile"),(o=(l=g.value)==null?void 0:l.unlocks)!=null&&o.term2?(d(),u("li",{key:0,onClick:e[4]||(e[4]=n=>_(C).push("/major-professor"))},"Major Professor")):v("",!0),(r=(p=g.value)==null?void 0:p.unlocks)!=null&&r.term3?(d(),u("li",{key:1,onClick:e[5]||(e[5]=n=>_(C).push("/thesis-project"))},"Thesis / Project")):v("",!0)])])]),a("main",Xe,[a("div",Ye,[e[17]||(e[17]=a("h2",null,"Upload Documents",-1)),a("div",Ze,[a("div",ea,[e[9]||(e[9]=a("h3",null,"Admission Letter",-1)),e[10]||(e[10]=a("p",{class:"text-muted"},"Required for Term 1 hold release.",-1)),O(W,{onChange:he,accept:".pdf,.jpg,.png"}),a("button",{class:"btn-primary",onClick:Ce,disabled:!$.value||B.value},i(B.value?"Uploading...":"Upload"),9,aa)]),a("div",sa,[e[11]||(e[11]=a("h3",null,"Major Professor Form",-1)),e[12]||(e[12]=a("p",{class:"text-muted"},"Required for Term 2 hold release.",-1)),(ce=(L=g.value)==null?void 0:L.unlocks)!=null&&ce.term2?v("",!0):(d(),u("div",la," Locked: available starting Term 2. ")),O(W,{onChange:ge,accept:".pdf,.jpg,.png",disabled:!((ve=(re=g.value)==null?void 0:re.unlocks)!=null&&ve.term2)},null,8,["disabled"]),a("button",{class:"btn-primary",onClick:we,disabled:!((pe=(me=g.value)==null?void 0:me.unlocks)!=null&&pe.term2)||!A.value||G.value},i(G.value?"Uploading...":"Upload"),9,ta)]),a("div",oa,[e[13]||(e[13]=a("h3",null,"Thesis / Project",-1)),e[14]||(e[14]=a("p",{class:"text-muted"},"Upload your thesis/project file (PDF). Allowed only in Term 3 and Term 4.",-1)),E.value?v("",!0):(d(),u("div",na," Locked: available only in Term 3 and Term 4. ")),O(W,{onChange:ye,disabled:!E.value,accept:".pdf"},null,8,["disabled"]),a("button",{class:"btn-primary",onClick:ke,disabled:!E.value||!j.value||I.value},i(I.value?"Uploading...":"Upload"),9,ua)]),a("div",da,[e[15]||(e[15]=a("h3",null,"Research Method (Proof)",-1)),e[16]||(e[16]=a("p",{class:"text-muted"}," Term 3 hold release requires you to register/take the Research Method course. Faculty will verify your course registration. Upload proof here if requested (PDF/JPG/PNG). ",-1)),H.value?v("",!0):(d(),u("div",ia," Locked: available starting Term 3. ")),O(W,{onChange:be,disabled:!H.value,accept:".pdf,.jpg,.jpeg,.png"},null,8,["disabled"]),a("button",{class:"btn-primary",onClick:Fe,disabled:!H.value||!T.value||z.value},i(z.value?"Uploading...":"Upload"),9,ca)])]),c.value?(d(),u("div",{key:0,class:q(["msg",{ok:m.value,bad:!m.value}])},i(c.value),3)):v("",!0)]),a("div",ra,[e[18]||(e[18]=a("h2",null,"My Documents",-1)),X.value?(d(),u("div",va,"Loading...")):Y.value.length===0?(d(),u("div",ma,"No documents uploaded.")):(d(),u("div",pa,[(d(!0),u(fe,null,_e(Y.value,n=>(d(),u("div",{key:n.doc_id,class:"doc-item"},[a("div",fa,[a("div",_a,[a("span",ha,i(_(We)(n.doc_type)),1),a("span",ga,i(_(Be)(n.file_path)),1),a("span",{class:q(["doc-status-pill",_(Ge)(n.status)])},i(_(Ie)(n.status)),3),n.upload_date?(d(),u("span",ya,"路 "+i(n.upload_date),1)):v("",!0)]),n.admin_comment?(d(),u("div",ba,"Reviewer comment: "+i(n.admin_comment),1)):v("",!0)]),a("div",ka,[a("button",{class:"btn-secondary",onClick:le=>De(n)},"View",8,Ca),a("button",{class:"btn-secondary",onClick:le=>Ue(n)},"Comments",8,wa),a("button",{class:"btn-secondary",onClick:le=>Te(n),disabled:!ue(n)},"Replace",8,Fa),a("button",{class:"btn-danger",onClick:le=>Le(n),disabled:!ue(n)},"Delete",8,Da)])]))),128))]))])])]),Z.value?(d(),u("div",Ua,[a("div",Ra,[e[19]||(e[19]=a("h3",null,"Comments",-1)),h.value?(d(),u("div",Ma,[a("strong",null,i(h.value.doc_type),1),oe(" 路 doc_id="+i(h.value.doc_id),1)])):v("",!0),a("div",ja,[ee.value?(d(),u("div",Ta,"Loading comments...")):N.value.length===0?(d(),u("div",Pa,"No comments yet.")):(d(),u("div",xa,[(d(!0),u(fe,null,_e(N.value,n=>(d(),u("div",{key:n.id,class:"comment-item"},[a("div",La,[a("span",$a,i(n.author_username||n.author_role),1),a("span",Aa,i(n.created_at),1)]),a("div",Na,i(n.comment),1)]))),128))]))]),Oe(a("textarea",{"onUpdate:modelValue":e[6]||(e[6]=n=>D.value=n),placeholder:"Add a note...",rows:"3"},null,512),[[qe,D.value]]),w.value?(d(),u("div",{key:1,class:q(["msg",{ok:P.value,bad:!P.value}])},i(w.value),3)):v("",!0),a("div",Sa,[a("button",{class:"btn-cancel",onClick:Re},"Close"),a("button",{class:"btn-primary",onClick:Me,disabled:J.value||!D.value.trim()||!h.value},i(J.value?"Posting...":"Post"),9,Va)])])])):v("",!0),ae.value?(d(),u("div",Oa,[a("div",qa,[e[20]||(e[20]=a("h3",null,"Replace Document",-1)),y.value?(d(),u("div",Wa,[a("strong",null,i(y.value.doc_type),1),oe(" 路 doc_id="+i(y.value.doc_id),1)])):v("",!0),O(W,{onChange:Pe,accept:je.value},null,8,["accept"]),b.value?(d(),u("div",{key:1,class:q(["msg",{ok:R.value,bad:!R.value}])},i(b.value),3)):v("",!0),a("div",Ba,[a("button",{class:"btn-cancel",onClick:de},"Cancel"),a("button",{class:"btn-primary",onClick:xe,disabled:K.value||!x.value||!y.value},i(K.value?"Uploading...":"Replace"),9,Ga)])])])):v("",!0),se.value?(d(),u("div",Ia,[a("div",za,[e[21]||(e[21]=a("h3",null,"Delete Document",-1)),F.value?(d(),u("div",Ja,[a("strong",null,i(F.value.doc_type),1),oe(" 路 "+i(F.value.file_path),1)])):v("",!0),e[22]||(e[22]=a("div",{class:"msg bad"},"This will remove the file from the system. Approved documents cannot be deleted.",-1)),k.value?(d(),u("div",{key:1,class:q(["msg",{ok:M.value,bad:!M.value}])},i(k.value),3)):v("",!0),a("div",Ea,[a("button",{class:"btn-cancel",onClick:ie,disabled:V.value},"Cancel",8,Ha),a("button",{class:"btn-danger",onClick:$e,disabled:V.value||!F.value},i(V.value?"Deleting...":"Delete"),9,Ka)])])])):v("",!0)])}}},as=Ne(Qa,[["__scopeId","data-v-52e4a04c"]]);export{as as default};
